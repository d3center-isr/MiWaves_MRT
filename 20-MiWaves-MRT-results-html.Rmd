---
title: "MiWaves MRT Analyses Results"
output: html_document
geometry: margin=2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```
## Frequencies of Baseline Covariates

Firstly, there are two baseline records for IDs 9 (populated both first and second submissions), 55 (partial first submission and populated second submission) and 102 (partial first submission and populated second submission), and for these three IDs I retain the second baseline record.  
  
1.)  CANN_IMPORTANCE_BL: "Right now, how important is it to you to cut back your cannabis use?" Response: 0-10 likert scale: 0=Not at all, 10=Very
  
Other options: 
  
-  CANN_LIKELY_BL: "Right now, how likely are you to cut back your use of cannabis or cannabis products?" Response: scale of 0=Not at all - 10=Very
  
-  CANN_CONF_BL: "How confident are you that you could cut back your use of cannabis or cannabis products if you wanted to?" Response: scale of 0=Not at all - 10=Very
  
2.)  CANNHOURS_BL: "During the past month, how many hours, on an average day, did you use cannabis?" Response: Drop down selection 0-24
  
3.)  CANNWAKE_BL: "During the past month, how soon did you typically use any cannabis products after you woke up for the day?" Response: 1=Within 5 minutes, 2=6-30 minutes, 3=31 minutes to almost 1 hour, 4=1 to almost 2 hours, 5=2 to almost 4 hours, 6=4 or more hours
  
Other options:   
  
-  CANNDAYS_BL: "How many days in the past month have you used cannabis?" Response: Drop down selection 0-31
  
-  CANNMONTH_BL: "In the past month, how many times per day did you use cannabis?" Response: Drop down selection 0-24
  
*Note*: If CANNDAYS_BL>0, then displays CANNHOURS_BL, CANNWAKE_BL, CANNMONTH_BL, CANN_IMPORTANCE_BL, CANN_LIKELY_BL, CANN_CONF_BL. 
  
   
```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(rtf)
library(jsonlite)
library(tidyjson)
library(lubridate)
library(knitr)
library(ggplot2)
library(kableExtra)

outdir<-"~/output"
proc_dat <- "//maize.umhsnas.med.umich.edu/Psychiatry/Restricted/MiWaves/Pilot/Processed Data/"

# load R datafile
load(file = paste0(proc_dat,"miwaves_analysis_dataset.Rdata"))

prim_dat <- prim_dat %>%
  # restrict to IDs with completed baseline survey
  filter( !(is.na(completed_baseline))) %>%
  mutate(cann_importance_bl= ifelse(is.na(cann_importance_bl),0,cann_importance_bl),
         cannhours_bl= ifelse(is.na(cannhours_bl),0,cannhours_bl),
         cannwake_bl= ifelse(is.na(cannwake_bl),0,cannwake_bl))

cann_importance_bl_freq <- prim_dat %>%
  select(id,cann_importance_bl)%>%
  distinct(id,cann_importance_bl)%>%
  mutate(flag=1)%>%
  group_by(cann_importance_bl) %>%
  # denominator is 120 IDs in analysis sample
  summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 120), 3))%>%
  ungroup()

cann_importance_bl_freq %>%
  kable(
    align = "c", caption = "Frequency of baseline variable: cann_importance_bl (N=120 EAs)")%>%
  kable_classic(full_width = F)
# kbl(cann_importance_bl_freq, booktabs = T)

cannhours_bl_freq <- prim_dat %>%
  select(id,cannhours_bl)%>%
  distinct(id,cannhours_bl)%>%
  mutate(flag=1)%>%
  group_by(cannhours_bl) %>%
  # denominator is 120 IDs in analysis sample
  summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 120), 3))%>%
  ungroup()

cannhours_bl_freq %>%
  kable(
    align = "c", caption = "Frequency of baseline variable: cannhours_bl (N=120 EAs)")%>%
  kable_classic(full_width = F)
# kbl(cannhours_bl_freq, booktabs = T)

cannwake_bl_freq <- prim_dat %>%
  select(id,cannwake_bl)%>%
  distinct(id,cannwake_bl)%>%
  mutate(flag=1)%>%
  group_by(cannwake_bl) %>%
  # denominator is 120 IDs in analysis sample
  summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 120), 3))%>%
  ungroup()

cannwake_bl_freq %>%
   kable(
     align = "c", caption = "Frequency of baseline variable: cannwake_bl (N=120 EAs)")%>%
   kable_classic(full_width = F)

# kbl(cannwake_bl_freq, booktabs = T)
```

## *Preliminary* Causal Excursion Effects
  
**Research Question 1**: Examine whether, on average, there is a proximal effect of delivering an intervention message on proximal cannabis use   
  
Proximal outcome ($Y_{i,t+1}$): Proportion of waking hours with self-reported cannabis use (0-1, treated as continuous)  
    
Treatment indicator ($A_{i,t}$): Binary (1=Yes message, 0=No message)  
  
Covariates:   

-  prior cannabis use – proportion of waking hours averaged over past 4 decision points (i.e., approximately 48 hours),    
-  time of day – binary (AM=0, PM=1)  
-  day of the week  – binary (weekday=1, weekend [Fri-Sun]=0)  
-  prior intervention engagement – score that ranges from 0-3 averaged over past 6 decision points (i.e., approximately 72 hours)  
-  baseline motivation to change – importance of cutting back cannabis use on a scale from 0 (Not at all) to 10 (Very) at time of baseline survey  
-  baseline cannabis use – self-reported average hours of cannabis use in prior day (range: 0-24), during the past month  
-  baseline time to cannabis use - self-reported time to cannabis use, since awaking (1=Within 5 minutes, 2=6-30 minutes, 3=31 minutes to almost 1 hour, 4=1 to almost 2 hours, 5=2 to almost 4 hours, 6=4 or more hours), during the past month  

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(rtf)
library(jsonlite)
library(tidyjson)
library(lubridate)
library(knitr)
library(ggplot2)
library(kableExtra)
library(MRTAnalysis)
library(gt)

df <- prim_dat %>%
  arrange(id,decision_point) %>%
  rename(actioni=intmessage_randassignment, probi= intmessage_randprob, 
         prior_interv_engag = interv_engagement, 
         message_length_char = message_length) %>%
  mutate(timeofday = ifelse(morning==1,0,1),
         message_interaction_type = ifelse(message_type == "A",1,
                                      ifelse(message_type=="B",2,
                                             ifelse(message_type=="C",3,1))),
         message_interaction_type = as.factor(message_interaction_type),
         prior_sent_message = lag(actioni),
         message_length = ifelse(message_length_char == "Short",1,
                                      ifelse(message_length_char=="Long",2,1)),
         message_length = as.factor(message_length)) %>%
  filter(!is.na(cov_prop_awakeuse_48hrs))

#print(paste0("Sample size: ",nrow(df)))

r <- list()

fit1 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~1
)

r[[1]] <- summary(fit1)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Model 1A (no covars)")
  
fit2 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~ cov_prop_awakeuse_48hrs + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
)

r[[2]] <- summary(fit2)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Model 1B (w/ covars)")


fit3 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~timeofday,
    control_formula = ~ cov_prop_awakeuse_48hrs + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
)

r[[3]] <- summary(fit3)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Model 1C (w/ covars & interaction)")

#df[is.na(df) | df=="Inf"] = NA
#df_modD <- df %>% filter(!is.na(message_type))
# fit4 <- wcls(
#     data = df,
#     id = "id",
#     outcome = "prop_awakeuse",
#     treatment = "actioni",
#     rand_prob = "probi",
#     moderator_formula = ~message_interaction_type,
#     control_formula = ~message_interaction_type + cov_prop_awakeuse_48hrs + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
# )
# 
# r[[4]] <- summary(fit4)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
#   mutate(model="Model 1D (w/ covars & interaction)")

df_modE <- df %>% filter(!is.na(prop_awakeuse_prior)) 

fit5a <- wcls(
    data = df_modE,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prop_awakeuse_prior,
    control_formula = ~prop_awakeuse_prior + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
)

r[[4]] <- summary(fit5a)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Model 1E Version 1 (w/ covars & interaction)")


fit5b <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_prop_awakeuse_48hrs,
    control_formula = ~cov_prop_awakeuse_48hrs + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
)

r[[5]] <- summary(fit5b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Model 1E Version 2 (w/ covars & interaction)")


fit6 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~week_day_binary,
    control_formula = ~cov_prop_awakeuse_48hrs + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
)

r[[6]] <- summary(fit6)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Model 1F (w/ covars & interaction)")

df_modG <- df %>% filter(!is.na(prior_interv_engag)) 
fit7a <- wcls(
    data = df_modG,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_interv_engag,
    control_formula = ~cov_prop_awakeuse_48hrs + prior_interv_engag  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
)

r[[7]] <- summary(fit7a)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Model 1G Version 1 (w/ covars & interaction)")

fit7b <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_interv_engag_72hrs,
    control_formula = ~cov_prop_awakeuse_48hrs + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
)

r[[8]] <- summary(fit7b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Model 1G Version 2 (w/ covars & interaction)")


df_modH <- df %>% filter(!is.na(prior_sent_message)) 
fit8a <- wcls(
    data = df_modH,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_sent_message,
    control_formula = ~prior_sent_message + cov_prop_awakeuse_48hrs + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
)

r[[9]] <- summary(fit8a)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Model 1H Version 1 (w/ covars & interaction)")

# fit8b <- wcls(
#     data = df,
#     id = "id",
#     outcome = "prop_awakeuse",
#     treatment = "actioni",
#     rand_prob = "probi",
#     moderator_formula = ~cov_interv_engag_72hrs,
#     control_formula = ~cov_prop_awakeuse_48hrs + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
# )
# 
# r[[10]] <- summary(fit8b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
#   mutate(model="Model 1H Version 2 (w/ covars & interaction)")


# df_modI <- df %>% filter(message_length!=999) 
# fit9 <- wcls(
#     data = df_modI,
#     id = "id",
#     outcome = "prop_awakeuse",
#     treatment = "actioni",
#     rand_prob = "probi",
#     moderator_formula = ~message_length,
#     control_formula = ~message_length + cov_prop_awakeuse_48hrs + cov_interv_engag_72hrs  + timeofday + week_day_binary + cann_importance_bl + cannhours_bl + cannwake_bl
# )
# 
# r[[10]] <- summary(fit9)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
#   mutate(model="Model 1I (w/ covars & interaction)")




res <- r %>% map_df(bind_rows) %>% select(model, everything())


# table output

out_table <- function(res){
  if (knitr::is_latex_output()) {
    res %>%
      mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>%
      select(-model) %>%  # Remove the model column
      kableExtra::kbl(booktabs = TRUE, 
                      format = "latex",
                      caption = NULL) %>%
      kableExtra::kable_styling(
        latex_options = c("striped", "hold_position"),
        font_size = 10,
        full_width = TRUE
      ) %>%
      kableExtra::pack_rows(index = table(res$model)) %>%
      kableExtra::column_spec(1, width = "3.5cm") %>%
      kableExtra::column_spec(7, width = "1cm") %>%
      kableExtra::column_spec(8, width = "1cm") %>%
      kableExtra::footnote(
        general = "Standard errors are not yet adjusted to account for RL uncertainty.",
        general_title = "",
        footnote_as_chunk = TRUE
      )
  } else {
    res %>% 
      mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>% 
      gt(groupname_col = "model") %>% 
      #cols_label(list = (term ~ "Term")) %>% 
      #gt_theme_pff() %>%
      tab_options(
        row_group.padding = px(3),
        row.striping.include_table_body = FALSE
        #quarto.disable_processing = TRUE
      ) %>%
      tab_style(
        style = cell_text(size = px(16)), 
        locations = cells_body()
      ) %>%
      tab_style(
        style = cell_text(size = px(16)),
        locations = cells_column_labels()
      ) %>%
      tab_style(
        style = cell_text(size = px(14)),
        locations = cells_row_groups()
      ) %>% 
      fmt(
        columns = c(`p-value`),
        fns = function(x) ifelse(x < 0.001, "<0.001", sprintf("%.3f", x))
      ) %>%
      fmt_number(
        columns = c(3:7),
        decimals = 2
      ) %>% 
      tab_footnote(
        footnote = "Standard errors are not yet adjusted to account for RL uncertainty.",
        locations = cells_row_groups()
      )
  }
}

out_table(res)
```
