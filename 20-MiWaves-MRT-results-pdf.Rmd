---
title: "MiWaves MRT Analyses Results"
output: pdf_document
geometry: margin=2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```
# 1. Primary Aims Analysis (Part 1) with Proximal Cannabis Use Outcome 
  
## Frequencies of Baseline Covariates

Firstly, there are two baseline records for three IDs. For these three IDs, the second baseline record is retained. The two baseline submissions are likely due to the survey timing out and participants re-submitting. 
  
1.)  *CANN_IMPORTANCE_BL*: "Right now, how important is it to you to cut back your cannabis use?" Response: 0-10 likert scale: 0=Not at all, 10=Very
  
Other options: 
  
-  *CANN_LIKELY_BL*: "Right now, how likely are you to cut back your use of cannabis or cannabis products?" Response: scale of 0=Not at all - 10=Very
  
-  *CANN_CONF_BL*: "How confident are you that you could cut back your use of cannabis or cannabis products if you wanted to?" Response: scale of 0=Not at all - 10=Very
  
2.)  *CANNHOURS_BL*: "During the past month, how many hours, on an average day, did you use cannabis?" Response: Drop down selection 0-24
  
3.)  *CANNWAKE_BL*: "During the past month, how soon did you typically use any cannabis products after you woke up for the day?" Response: 1=Within 5 minutes, 2=6-30 minutes, 3=31 minutes to almost 1 hour, 4=1 to almost 2 hours, 5=2 to almost 4 hours, 6=4 or more hours
  
Other options:   
  
-  *CANNDAYS_BL*: "How many days in the past month have you used cannabis?" Response: Drop down selection 0-31
  
-  *CANNMONTH_BL*: "In the past month, how many times per day did you use cannabis?" Response: Drop down selection 0-24
  
*Note*: If *CANNDAYS_BL*>0, then displays *CANNHOURS_BL*, *CANNWAKE_BL*, *CANNMONTH_BL*, *CANN_IMPORTANCE_BL*, *CANN_LIKELY_BL*, and *CANN_CONF_BL*. 
  
   
```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(knitr)
library(ggplot2)
library(kableExtra)

# function for cumulative sum
stats_csum <- function(var){
  ifelse(is.na(var)==T, NA, cumsum(replace_na(var,0)))
}

outdir<-"~/output"
proc_dat <- "//maize.umhsnas.med.umich.edu/Psychiatry/Restricted/MiWaves/Pilot/Processed Data/"

# load R datafile
 load(file = paste0(proc_dat,"miwaves_analysis_dataset_w_bl.Rdata"))

full_dat <- prim_dat %>%
  dplyr::arrange(id,decision_point) %>%
  # restrict to IDs with completed baseline survey
  dplyr::filter( !(is.na(completed_baseline))) %>%
  dplyr::mutate(cann_importance_bl= ifelse(is.na(cann_importance_bl),0,cann_importance_bl),
         cann_likely_bl= ifelse(is.na(cann_likely_bl),0,cann_likely_bl),
         cann_conf_bl= ifelse(is.na(cann_conf_bl),0,cann_conf_bl),
         cannhours_bl= ifelse(is.na(cannhours_bl),0,cannhours_bl),
         cannwake_bl= ifelse(is.na(cannwake_bl),0,cannwake_bl),
         high_cann_importance_bl = ifelse(cann_importance_bl < 5, 0,
                                          ifelse(cann_importance_bl >= 5, 1, 999)),
         high_cann_importance_bl = factor(high_cann_importance_bl, levels=c(0,1)),
         sex = factor(sex, levels=c(1,2), labels=c("Male", "Female")),
         male_sex = ifelse(sex=="Male", 1, 0),
         male_sex = factor(male_sex),
         white_race = factor(white_race),
         ethnicity = factor(ethnicity, levels=c(1,2), labels=c("Hispanic or Latino", "Not Hispanic or Latino")),
         hispanic_ethn = ifelse(ethnicity=="Hispanic or Latino", 1, 0),
         hispanic_ethn = factor(hispanic_ethn)) %>%
  dplyr::rename(actioni=intmessage_randassignment, probi= intmessage_randprob, 
         prior_interv_engag = pre_engagement_multi) %>%
  dplyr::mutate(timeofday = ifelse(morning==1,0,1),
                timeofday = factor(timeofday, levels=c(0,1), labels=c("AM", "PM")),
                week_day_binary = factor(week_day_binary),
         message_interaction_type = ifelse(message_type == "A",1,
                                      ifelse(message_type=="B",2,
                                             ifelse(message_type=="C",3,1))),
         message_interaction_type = as.factor(message_interaction_type),
         message_length = ifelse(is.na(message_length),"Not applicable",message_length),
         # create time since under treatment (i.e., since study start) in weeks
         wks_since_interv_start = case_when(day<=7              ~ 1,
                                           (day>7) & (day<=14)  ~ 2,
                                           (day>14) & (day<=21) ~ 3,
                                           (day>21) & (day<=30) ~ 4),
         after_day15 = case_when(day<=15 ~ 0,
                                 day>15  ~ 1),
         after_day15 = factor(after_day15)
        ) %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(# create prior sending of a message candidate moderator
         prior_sent_message = lag(actioni),
         # create cumulative number of messages sent to decision point t
         cumul_num_message = stats_csum(actioni),
         cumul_num_message_sq = cumul_num_message^2,
         log_awakeuse_offs = prop_awakeuse + 0.001,
         log_awakeuse = log(log_awakeuse_offs),
         logit_awakeuse = log((log_awakeuse_offs)/(1-(log_awakeuse_offs))),
         # make binary version of cannabis use numeric
         can_yes_no_l = as.character(can_yes_no_l),
         can_yes_no_l = ifelse(can_yes_no_l=="Yes",1,
                               ifelse(can_yes_no_l=="No",0,999)),
         # create numeric version of behavior activity question response
         prior_beh_activity_response = ifelse(pre_engagement_activity_response == "True",1,
                                              ifelse(pre_engagement_activity_response == "False",0,NA))
         ) %>%
  dplyr::ungroup() 

df <- full_dat %>%
  # restrict to participants with at least 3 completed EMAs
  dplyr::filter(num_emas_l >= 3) %>%
  # remove observations where the randomization information is missing
  dplyr::filter(missing_rand != 1) %>%
  dplyr::filter(!is.na(prop_awakeuse))%>% # 5306 obs remaining after this restriction
  dplyr::filter(!is.na(cov_prop_awakeuse_48hrs)) %>% # 5289 obs remaining after this restriction
  dplyr::filter(!is.na(cov_interv_engag_24hrs)) # 5271 obs remaining after this restriction

mean_motivation <- df %>%
  dplyr::mutate(grand_mean = mean(cann_importance_bl,na.rm=T))%>%
  dplyr::select(id,cann_importance_bl, grand_mean) %>%
  dplyr::distinct(id,cann_importance_bl, grand_mean)%>%
  dplyr::mutate(pt_mean = mean(cann_importance_bl,na.rm=T)) %>%
  dplyr::select(pt_mean,grand_mean) %>% distinct(pt_mean,grand_mean)

cann_importance_bl_freq <- df %>%
  select(id,cann_importance_bl)%>%
  distinct(id,cann_importance_bl)%>%
  mutate(flag=1)%>%
  group_by(cann_importance_bl) %>%
  # denominator is 120 IDs in analysis sample
  summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 120), 3))%>%
  ungroup()

cann_importance_bl_freq %>%
  kable(
    align = "c", caption = "Frequency of baseline variable cannabis importance $(N=120 EAs)$")%>%
  kable_classic(full_width = F)


high_cann_importance_bl_freq <- df %>%
  select(id,high_cann_importance_bl)%>%
  distinct(id,high_cann_importance_bl)%>%
  mutate(flag=1)%>%
  group_by(high_cann_importance_bl) %>%
  # denominator is 120 IDs in analysis sample
  summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 120), 3))%>%
  ungroup()

high_cann_importance_bl_freq %>%
  kable(
    align = "c", caption = "Frequency of baseline dichotomized variable high cannabis importance $(N=120 EAs)$")%>%
  kable_classic(full_width = F)

cann_likely_bl_freq <- df %>%
  select(id,cann_likely_bl)%>%
  distinct(id,cann_likely_bl)%>%
  mutate(flag=1)%>%
  group_by(cann_likely_bl) %>%
  # denominator is 120 IDs in analysis sample
  summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 120), 3))%>%
  ungroup()

cann_likely_bl_freq %>%
  kable(
    align = "c", caption = "Frequency of baseline variable cannabis likely $(N=120 EAs)$")%>%
  kable_classic(full_width = F)

cann_conf_bl_freq <- df %>%
  select(id,cann_conf_bl)%>%
  distinct(id,cann_conf_bl)%>%
  mutate(flag=1)%>%
  group_by(cann_conf_bl) %>%
  # denominator is 120 IDs in analysis sample
  summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 120), 3))%>%
  ungroup()

cann_conf_bl_freq %>%
  kable(
    align = "c", caption = "Frequency of baseline variable cannabis confidence $(N=120 EAs)$")%>%
  kable_classic(full_width = F)

cannhours_bl_freq <- df %>%
  select(id,cannhours_bl)%>%
  distinct(id,cannhours_bl)%>%
  mutate(flag=1)%>%
  group_by(cannhours_bl) %>%
  # denominator is 120 IDs in analysis sample
  summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 120), 3))%>%
  ungroup()

cannhours_bl_freq %>%
  kable(
    align = "c", caption = "Frequency of baseline variable cannabis hours $(N=120 EAs)$")%>%
  kable_classic(full_width = F)

cannwake_bl_freq <- df %>%
  select(id,cannwake_bl)%>%
  distinct(id,cannwake_bl)%>%
  mutate(flag=1)%>%
  group_by(cannwake_bl) %>%
  # denominator is 120 IDs in analysis sample
  summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 120), 3))%>%
  ungroup()

cannwake_bl_freq %>%
   kable(
     align = "c", caption = "Frequency of baseline variable cannabis after waking $(N=120 EAs)$")%>%
   kable_classic(full_width = F)
```

## Distribution of Self-Reported Proportion of Waking Hours with Cannabis Use by Baseline Candidate Moderators

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(knitr)
library(ggplot2)


df$Action = factor(df$actioni,levels=c(0,1),labels=c("No Message","Yes Message"))

colors <- c("#dc0000ff","#00a087ff")
plot_violin <- function(dat, category_lbl, x_axis_lbl, metric, metric_lbl, low_limit, high_limit) {
  ggplot(dat, aes(x = get(category_lbl), y = get(metric), 
         color = Action, fill=Action)) +
    geom_violin(alpha = 0.2) +
    geom_boxplot(width = 0.2, position = position_dodge(width=0.9), 
                 outlier.shape = NA, alpha = 0.3) +
    theme_minimal() +
    scale_y_continuous(breaks=scales::breaks_pretty(n = 10), 
                       limits=c(low_limit, high_limit)) +
    scale_color_manual(values = colors) +
    scale_fill_manual(values = colors) + 
    scale_x_discrete(labels=xlabs) +
    labs(y = metric_lbl, x = x_axis_lbl) +
    theme(legend.title = element_blank(),
          legend.position = "bottom",
          text=element_text(size=11))
}

# Proportion of Awake Hours with Self-Reported Cannabis Use
xlabs <- paste(c("Male","Female"),"\n(n=",table(df$sex_lbl),")",sep="")
p1 <-plot_violin(dat=df, category_lbl="sex_lbl", x_axis_lbl="Biological Sex", metric="prop_awakeuse",metric_lbl="Self-Reported Proportion of Waking Hours Using Cannabis", low_limit = 0.0, high_limit=1)
print(p1)

xlabs <- paste(c("Asian","Black/African American", "> 1 race","Other", "Unknown", "White"),"\n(n=",table(df$race_lbl),")",sep="")
p2 <-plot_violin(dat=df, category_lbl="race_lbl", x_axis_lbl="Self-Reported Race", metric="prop_awakeuse",metric_lbl="Self-Reported Proportion of Waking Hours Using Cannabis", low_limit = 0.0, high_limit=1)
print(p2)

xlabs <- paste(c("Hispanic or Latino","Not Hispanic or Latino"),"\n(n=",table(df$ethnicity_lbl),")",sep="")
p3 <-plot_violin(dat=df, category_lbl="ethnicity_lbl", x_axis_lbl="Self-Reported Ethnicity", metric="prop_awakeuse",metric_lbl="Self-Reported Proportion of Waking Hours Using Cannabis", low_limit = 0.0, high_limit=1)
print(p3)


```

\newpage
## Trajectory of Cannabis Use Over Time
```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(ggplot2)
t1 <- df %>% 
  # left_join(means1, by="id") %>% 
  # mutate(Action = factor(intmessage_randassignment,levels=c(0,1),labels=c("No Message","Yes Message"))
  #        #,canuse = prop_awakeuse - mean_canuse
  #        ) %>% 
  # filter(!is.na(Action)) %>% 
  group_by(day) %>% 
  summarise(mcanuse=mean(prop_awakeuse, na.rm = TRUE)) %>%
  ggplot(aes(day, mcanuse)) +
  geom_hline(yintercept = 0, color="gray") +
  geom_point(size=2, color = "navy", fill="navy") +
  #scale_color_manual(values = colors) +
  #scale_fill_manual(values = colors) +
  geom_smooth(method = loess, se = FALSE, alpha=0.25,linewidth=1.2,color = "blue", fill="blue") +
  scale_x_continuous(breaks = c(1,5,10,15,20,25,30),expand = c(0,0.1),limits=c(1,30)) +
  theme_bw()+
  coord_cartesian(ylim=c(0,0.5)) +
  theme(text=element_text(family = "Helvetica",size = 10)
        #legend.position = "bottom",
        #legend.title=element_blank(), 
        ) +
  labs(x = "Day in Study",
       y = "Mean Proportion of Waking Hours Using Cannabis") 

print(t1)


colors <- c("#dc0000ff","#00a087ff")
means1 <- df %>%
  group_by(id) %>%
  summarise(mean_canuse = mean(prop_awakeuse,na.rm=T))%>%
  ungroup()

t2 <- df %>% 
  left_join(means1, by="id") %>% 
  mutate(Action = factor(actioni,levels=c(0,1),labels=c("No Message","Yes Message"))
         #,canuse = prop_awakeuse - mean_canuse
         ) %>% 
  filter(!is.na(Action)) %>% 
  group_by(day, Action) %>% 
  summarise(mcanuse=mean(prop_awakeuse, na.rm = TRUE)) %>%
  ggplot(aes(day, mcanuse, color = Action, fill=Action)) +
  geom_hline(yintercept = 0, color="gray") +
  geom_point(size=2,alpha=0.7) +
  scale_color_manual(values = colors) +
  scale_fill_manual(values = colors) +
  geom_smooth(method = lm, linewidth=1.1, alpha=0.20) +
  scale_x_continuous(breaks = c(1,5,10,15,20,25,30),expand = c(0,0.1),limits=c(1,30)) +
  theme_bw()+
  coord_cartesian(ylim=c(0,0.5)) +
  theme(legend.position = "bottom",
        legend.title=element_blank(),
        plot.title=element_text(size=11), 
        axis.title=element_text(size=11),
        axis.text.x=element_text(size=11),
        axis.text.y=element_text(size=11)) +
  labs(x = "Day in Study",
       y = "Mean Proportion of Waking Hours Using Cannabis") 

print(t2)


```

\newpage
## Overall Distribution of Proximal Outcome 
```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(ggplot2)

h1 <- ggplot(data=df,aes(x=prop_awakeuse)) +
  geom_histogram(alpha=.5) + 
  theme_bw() +
  scale_x_continuous(expand = c(0,0.01)) +
  theme(text = element_text(family = "Helvetica",size = 10)) + 
  ggtitle("") + labs(x = "Proportion of Hours with Cannabis Use", y = "Count of Decision Points")

h2 <- ggplot(data=df,aes(x=log_awakeuse)) +
  geom_histogram(alpha=.5) + 
  theme_bw() +
  theme(text = element_text(family = "Helvetica",size = 10)) + 
  ggtitle("") + labs(x = "log(p)", y = "Count of Decision Points")

h3 <- ggplot(data=df,aes(x=logit_awakeuse)) +
  geom_histogram(alpha=.5) + 
  theme_bw() +
  theme(text = element_text(family = "Helvetica",size = 10)) +
  ggtitle("") + labs(x = "log(p/(1-p))", y = "Count of Decision Points")

cowplot::plot_grid( 
  h1,
  h2,
  h3
)

```
\newpage
  
## *Preliminary* Causal Excursion Effect Estimates
  
**Research Question 1**: Examine whether, on average, there is a proximal effect of delivering an intervention message on proximal cannabis use   
  
**Proximal outcome ($Y_{i,t+1}$)**: Proportion of waking hours with self-reported cannabis use (0-1, treated as continuous)  
    
**Treatment indicator ($A_{i,t}$)**: Binary (1=Yes message, 0=No message)  
  
**Covariates**:  
  
-  time of day – binary (AM=0, PM=1),  
  
-  day of the week – binary (weekday=1, weekend [Fri-Sun]=0),  
  
-  prior cannabis use – proportion of waking hours averaged over past 4 decision points (i.e., approximately 48 hours), 
  
-  prior intervention engagement – score that ranges from 0-3 averaged over past 6 decision points (i.e., approximately 72 hours),  
  
-  baseline motivation to change – importance of cutting back cannabis use on a scale from 0 (Not at all) to 10 (Very) at time of baseline survey,  
  
-  baseline cannabis use – self-reported average hours of cannabis use in prior day (range: 0-24), during the past month, and 
  
-  baseline time to cannabis use - self-reported time to cannabis use, since awaking (1=Within 5 minutes, 2=6-30 minutes, 3=31 minutes to almost 1 hour, 4=1 to almost 2 hours, 5=2 to almost 4 hours, 6=4 or more hours), during the past month.  
**Research Question 2**: Explore whether the effect of the intervention message on proximal cannabis use varies by each of the candidate moderators listed below.  
  
**Candidate Moderators**:   
  
1. *timeofday*: time of day – binary (AM=0, PM=1),
  
2. *interact_A_message*: interaction type A message vs. no message – binary (interaction type A message=1, no message=0),  
  
- 2.2. *interact_B_message*: interaction type B message vs. no message – binary (interaction type B message=1, no message=0),  
  
- 2.3. *interact_C_message*: interaction type C message vs. no message – binary (interaction type C message=1, no message=0),
  
3. *prop_awakeuse_prior*: prior cannabis use – operationalized the same as the proximal outcome, at the prior decision point,
  
- 3.2. *cov_prop_awakeuse_48hrs*: prior cannabis use over the past 4 decision points,
  
4. *wks_since_interv_start*: time since under treatment (i.e., since intervention start) in weeks,

- 4.2 *after_day15* [a]: time since under treatment (i.e., since intervention start) dichotomized (0=before and including day 15, 1=after day 15),
  
5. *week_day_binary*: day of the week – binary (weekday=1, weekend [Fri-Sun]=0),
  
6. *prior_interv_engag*: prior intervention engagement – operationalized the same as the proximal outcome, at the prior decision point,
  
- 6.2. *cov_interv_engag_24hrs*: over past 2 decision points,
  
7. *prior_sent_message*: prior delivery of a message – binary (yes message=1, no message=0), at the prior decision point,
  
- 7.2. *prior_sent_messages_48hrs*: number of messages sent over past 4 decision points,
  
8. *short_message*: short message vs. no message – binary (short message=1, no message=0),  
  
- 8.2. *long_message*: long message vs. no message - binary (long message=1, no message=0),  
  
9. *male_sex*: baseline demographic of male biological sex (0=female,1=male),  
  
10. *white_race*: baseline demographic of white race (0=not white, 1=white),   
  
11. *hispanic_ethn*: baseline demographic of hispanic or latino ethnicity (0=not hispanic or latino, 1=hispanic or latino),
  
12. *canndays_bl*: baseline cannabis use severity that is the number of days used cannabis in past month (range: 0-31), which reflects cannabis use frequency, 
  
- 12.2. *dsmsc_tot_bl*: baseline cannabis use severity that is the count of number of symptoms endorsed (range: 0-11), which reflects diagnostic severity,  
  
13. *cann_importance_bl*: baseline motivation to change that is the importance of cutting back cannabis use on a scale from 0 (Not at all) to 10 (Very) at time of baseline survey, 
  
- 13.2. *high_cann_importance_bl* [a]: baseline motivation to change - binary (0=low motivation to change [score<5], 1=high motivation to change [score>=5]),
  
- 13.3. *cann_likely_bl* [a]: baseline likelihood to change that is how likely one is to cut back cannabis use on a scale from 0 (Not at all) to 10 (Very) at the time of baseline survey,  
  
- 13.4. *cann_conf_bl* [a]: baseline confidence to change that is how confident one is to cut back cannabis use on a scale from 0 (Not at all) to 10 (Very) at the time of baseline survey, 

- 13.5. *cann_importance_bl* [a]: baseline motivation to change on a scale from 0 (Not at all) to 10 (Very) at the time of baseline survey, when restricting to within week 1 (days 1-7),

- 13.6. *cann_importance_bl* [a]: baseline motivation to change on a scale from 0 (Not at all) to 10 (Very) at the time of baseline survey, when restricting to within week 2 (days 8-14),

- 13.7. *cann_importance_bl* [a]: baseline motivation to change on a scale from 0 (Not at all) to 10 (Very) at the time of baseline survey, when restricting to within week 3 (days 15-21),

- 13.8. *cann_importance_bl* [a]: baseline motivation to change on a scale from 0 (Not at all) to 10 (Very) at the time of baseline survey, when restricting to within week 4 onwards (days 22-30),
  
14. *phq2_tot_bl*: baseline mental health, which is the sum across two item scale PHQ-2 ("Over the last two weeks, how often have you been bothered by any of the following problems? Little interest or pleasure in doing things" and "Over the last two weeks, how often have you been bothered by any of the following problems? Feeling down, depressed, or hopeless" with response values of 0=Not at all, 1= Several days, 2=More than half the days, and 3=Nearly every day).

Notes: All continuous candidate moderators are mean-centered. The continuous proximal outcome is also mean-centered for interpretation of the fully marginal causal excursion effect.
[a] This candidate moderator was included after the list of moderators was formalized.

\newpage
```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(knitr)
library(ggplot2)
library(kableExtra)
library(MRTAnalysis)
library(gt)

#print(paste0("Sample size: ",nrow(df)))

# center by grand mean
# specify list of continuous covariates that intend to mean center
vars.standardize <- c("prop_awakeuse_prior","cov_prop_awakeuse_48hrs",
                      "prior_interv_engag","cov_interv_engag_24hrs","cov_interv_engag_72hrs","prior_sent_messages_48hrs",
                      "canndays_bl","dsmsc_tot_bl",
                      "cann_importance_bl","cann_likely_bl","cann_conf_bl",
                      "phq2_tot_bl","cannwake_bl","cannhours_bl","cov_humtch_binary_48hrs")

cntr_fnc <- function(var){
  var - mean(var,na.rm=T)
}

df <- df %>%
  dplyr::mutate(across(all_of(vars.standardize),cntr_fnc,.names = "{col}_c"),
                # mean-center the proximal outcome to aid with interpretation
                across(all_of(c("prop_awakeuse","engagement_multi")),cntr_fnc,
                       .names = "{col}_c"))

r <- list()

fit_wocov <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~1
)

r[[1]] <- summary(fit_wocov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (no covars)")

fit_wcov <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~ cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[2]] <- summary(fit_wcov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (with covars)")

fit1 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~timeofday,
    control_formula = ~ cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[3]] <- summary(fit1)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 1")

# type of interaction (A, B or C) – categorical (A=0, B=1, C=2)
df_temp <- df %>% 
  # restrict to interaction A type message and no message
  filter(!(message_type %in% c("B","C"))) %>%
  mutate(interact_A_message = ifelse(actioni==0,0,1))

fit2 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "interact_A_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[4]] <- summary(fit2)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 2")

# type of interaction (A, B or C) – categorical (A=0, B=1, C=2)
df_temp <- df %>% 
  # restrict to interaction B type message and no message
  filter(!(message_type %in% c("A","C"))) %>%
  mutate(interact_B_message = ifelse(actioni==0,0,1))

fit2b <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "interact_B_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[5]] <- summary(fit2b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 2.2")


# type of interaction (A, B or C) – categorical (A=0, B=1, C=2)
df_temp <- df %>% 
  # restrict to interaction C type message and no message
  filter(!(message_type %in% c("A","B"))) %>%
  mutate(interact_C_message = ifelse(actioni==0,0,1))

fit2c <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "interact_C_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[6]] <- summary(fit2c)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 2.3")

df_temp <- df %>% filter(!is.na(prop_awakeuse_prior)) 
fit3 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prop_awakeuse_prior_c,
    control_formula = ~prop_awakeuse_prior_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[7]] <- summary(fit3)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 3")

fit3b <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_prop_awakeuse_48hrs_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[8]] <- summary(fit3b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 3.2")

fit4 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~wks_since_interv_start,
    control_formula = ~wks_since_interv_start + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[9]] <- summary(fit4)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 4")

fit4b <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~after_day15,
    control_formula = ~after_day15 + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[10]] <- summary(fit4b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 4.2")

fit5 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~week_day_binary,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[11]] <- summary(fit5)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 5")

df_temp <- df %>% filter(!is.na(prior_interv_engag)) 

fit6 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_interv_engag_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + prior_interv_engag_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[12]] <- summary(fit6)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 6")

fit6b <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_interv_engag_24hrs_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[13]] <- summary(fit6b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 6.2")

df_temp <- df %>% filter(!is.na(prior_sent_message)) 
fit7 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_sent_message,
    control_formula = ~prior_sent_message + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[14]] <- summary(fit7)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 7")

df_temp <- df %>% filter(!is.na(prior_sent_messages_48hrs)) 

fit7b <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_sent_messages_48hrs_c,
    control_formula = ~prior_sent_messages_48hrs_c + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[15]] <- summary(fit7b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 7.2")

# short vs no message
df_temp <- df %>%
  # restrict to short message and no message
  filter(message_length!="Long") %>%
  mutate(short_message = ifelse(actioni==0,0,1)) 

fit8 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "short_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[16]] <- summary(fit8)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 8")


# # long vs no message
df_temp <- df %>%
  # restrict to long message and no message
  filter(message_length!="Short") %>%
  mutate(long_message = ifelse(actioni==0,0,1))

fit8b <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "long_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[17]] <- summary(fit8b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 8.2")

fit9 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~male_sex,
    control_formula = ~male_sex + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[18]] <- summary(fit9)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 9")

fit10 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~white_race,
    control_formula = ~white_race + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[19]] <- summary(fit10)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 10")

fit11 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~hispanic_ethn,
    control_formula = ~hispanic_ethn + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[20]] <- summary(fit11)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 11")

fit12 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~canndays_bl_c,
    control_formula = ~ canndays_bl_c + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[21]] <- summary(fit12)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 12")

fit12b <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~dsmsc_tot_bl_c,
    control_formula = ~dsmsc_tot_bl_c + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[22]] <- summary(fit12b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 12.2")

# b1 + b3*(4.8) = 0.009 + ((-0.005) * 4.8)
fit13_can <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_importance_bl_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[23]] <- summary(fit13_can,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13")

fit13b <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~high_cann_importance_bl,
    control_formula = ~high_cann_importance_bl + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[24]] <- summary(fit13b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13.2")

fit13c <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_likely_bl_c,
    control_formula = ~cann_likely_bl_c + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[25]] <- summary(fit13c)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13.3")

fit13d <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_conf_bl_c,
    control_formula = ~cann_conf_bl_c + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[26]] <- summary(fit13d)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13.4")

df_temp <- df %>% filter(wks_since_interv_start==1)
fit13e <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_importance_bl_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[27]] <- summary(fit13e,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13.5")

df_temp <- df %>% filter(wks_since_interv_start==2)
fit13f <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_importance_bl_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[28]] <- summary(fit13f,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13.6")

df_temp <- df %>% filter(wks_since_interv_start==3)
fit13g <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_importance_bl_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[29]] <- summary(fit13g,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13.7")

df_temp <- df %>% filter(wks_since_interv_start==4)
fit13h <- wcls(
    data = df_temp,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_importance_bl_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[30]] <- summary(fit13h,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13.8")

fit14 <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~phq2_tot_bl_c,
    control_formula = ~phq2_tot_bl_c + cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[31]] <- summary(fit14)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 14")


res <- r %>% 
  map_df(bind_rows) %>% 
  select(model, everything()) %>%
  dplyr::mutate(model_num = gsub("Moderation Effect Model ","",model),
         model_num = ifelse(model=="Main Effect Model (no covars)","0",
                            ifelse(model=="Main Effect Model (with covars)","0.5",model_num)),
         model_num = as.numeric(model_num)
  )%>%
  dplyr::arrange(model_num) 

# create table with output
res_table <- function(res){
    res %>%
      mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>%
      rename(Term = term)%>%
      select(-c(model,model_num)) %>%
      kableExtra::kbl(booktabs = TRUE, 
                      longtable = TRUE,
                      digits=3,
                      format = "latex",
                      caption = NULL) %>%
      kableExtra::kable_styling(
        latex_options = c("striped", "hold_position", "repeat_header"),
        font_size = 10
        #full_width = TRUE
      ) %>%
      kableExtra::pack_rows(index = table(fct_inorder(res$model))) %>%
      kableExtra::column_spec(1, width = "6cm") %>%
      kableExtra::column_spec(7, width = "0.5cm") %>%
      kableExtra::column_spec(8, width = "0.5cm") %>%
      kableExtra::footnote(
        general = "baseline cannabis use, and baseline time to cannabis use.", general_title = "", footnote_as_chunk = T
      ) %>%
      kableExtra::footnote(
        general = "prior cannabis use, prior intervention engagement, baseline motivation to change,",
        general_title = "", footnote_as_chunk = T
      )%>%
      kableExtra::footnote(
        general = "Notes: Moderation Effect Models include the covariates: time of day, day of week,", general_title = "", footnote_as_chunk = T
      )
}

res_table(res)

```

\newpage

Next, let us examine the causal excursion effect of prompting with a message (vs. no message) for the binary version of proximal cannabis use (1=Yes cannabis use, 0=No cannabis use). Note that the binary proximal cannabis use outcome uses the raw EMA variable *can_yes_no* (question: “In the past 12 hours, have you used any cannabis product?”; values: "yes", "no"), and adjusted to reflect the next decision point. Therefore, the proximal outcome does *not* only reflect waking hours, and instead reflects *any* self-reported cannabis use (yes/no) at the next decision point.

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(knitr)
library(ggplot2)
library(kableExtra)
library(MRTAnalysis)
library(gt)

r <- list()

fit_wocov <- emee(
    data = df,
    id = "id",
    outcome = "can_yes_no_l",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~1
)

r[[1]] <- summary(fit_wocov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (no covars)")

fit_wcov <- emee(
    data = df,
    id = "id",
    outcome = "can_yes_no_l",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~ cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c  + timeofday + week_day_binary + cann_importance_bl_c + cannhours_bl_c + cannwake_bl_c
)

r[[2]] <- summary(fit_wcov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (with covars)")

res <- r %>% 
  map_df(bind_rows) %>% 
  select(model, everything()) %>%
  dplyr::mutate(model_num = gsub("Moderation Effect Model ","",model),
         model_num = ifelse(model=="Main Effect Model (no covars)","0",
                            ifelse(model=="Main Effect Model (with covars)","0.5",model_num)),
         model_num = as.numeric(model_num)
  )%>%
  dplyr::arrange(model_num) 

# create table with output
res_table <- function(res){
    res %>%
      mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>%
      rename(Term = term,
             `Log Odds Estimate` = Estimate)%>%
      select(-c(model,model_num)) %>%
      kableExtra::kbl(booktabs = TRUE, 
                      longtable = TRUE,
                      digits=3,
                      format = "latex",
                      caption = NULL) %>%
      kableExtra::kable_styling(
        latex_options = c("striped", "hold_position", "repeat_header"),
        font_size = 10
        #full_width = TRUE
      ) %>%
      kableExtra::pack_rows(index = table(fct_inorder(res$model))) %>%
      kableExtra::column_spec(1, width = "6cm") %>%
      kableExtra::column_spec(7, width = "0.5cm") %>%
      kableExtra::column_spec(8, width = "0.5cm") %>%
      kableExtra::footnote(
        general = "baseline cannabis use, and baseline time to cannabis use.", general_title = "", footnote_as_chunk = T
      ) %>%
      kableExtra::footnote(
        general = "prior cannabis use, prior intervention engagement, baseline motivation to change,",
        general_title = "", footnote_as_chunk = T
      )%>%
      kableExtra::footnote(
        general = "Notes: Precision covariates include the following: time of day, day of week,", general_title = "", footnote_as_chunk = T
      ) 
}

res_table(res)

```
\newpage
# 2. Primary Aims Analysis (Part 2) with Proximal Intervention Engagement Outcome
  
## Initial Diagnostics  
  
First, let us examine the app_use_flag to see whether this solely captures browsing aside from EMA completion.

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}

# run with sample size that reflects only missingness in the app use component of intervention engagement
df_engag_temp <- full_dat %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(app_use_flag_l = lead(app_use_flag)) %>%
  dplyr::ungroup()%>%
  # restrict to participants with at least 3 completed EMAs
  dplyr::filter(num_emas_l >= 3) %>%
  # remove observations where the randomization information is missing
  dplyr::filter(missing_rand != 1) %>%
  dplyr::filter(!is.na(app_use_flag_l))

app_use_flag_freq <- df_engag_temp %>%
  dplyr::mutate(flag=1)%>%
  dplyr::group_by(app_use_flag_l,completed_ema_l) %>%
  # denominator is 7038 DPs in engagement analysis sample
  dplyr::summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 7038), 3))%>%
  dplyr::ungroup()

app_use_flag_freq %>%
  kable(
    align = "c", caption = "Crosstabulation of app use flag variable and indicator for EMA completed $(N=7038 DPs)$")%>%
  kable_classic(full_width = F)

```

Next, with the newly constructed engagement scores, let us examine the number of decision points where the engagement score changed values, from the old version to the new version. Note that the engagement score displayed below is the multi-category version (*engagement_multi*) and reflects proximal intervention engagement at t+1, i.e. following randomization at t.
  

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}

# run with sample size that reflects only missingness in proximal intervention engagement
df_engag_temp <- full_dat %>%
  # restrict to participants with at least 3 completed EMAs
  dplyr::filter(num_emas_l >= 3) %>%
  # remove observations where the randomization information is missing
  dplyr::filter(missing_rand != 1) %>%
  dplyr::filter(!is.na(engagement_multi))

engag_crosstab <- df_engag_temp %>%
  dplyr::mutate(flag=1)%>%
  dplyr::group_by(interv_engagement_l,engagement_multi) %>%
  # denominator is 7038 DPs in engagement analysis sample
  dplyr::summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 7038), 3))%>%
  dplyr::ungroup() %>%
  dplyr::rename(`old engagement score` = interv_engagement_l, 
                `new engagement score` = engagement_multi )

engag_crosstab %>%
  kable(
    align = "c", caption = "Crosstabulation of old engagement and new engagement scores $(N=7038 DPs)$")%>%
  kable_classic(full_width = F)

engag_freq_new <- df_engag_temp %>%
  dplyr::mutate(flag=1)%>%
  dplyr::group_by(engagement_multi) %>%
  # denominator is 7038 DPs in engagement analysis sample
  dplyr::summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 7038), 3))%>%
  dplyr::ungroup() %>%
  dplyr::rename(`new engagement score` = engagement_multi)

engag_freq_new %>%
  kable(
    align = "c", caption = "Frequency of new engagement score $(N=7038 DPs)$")%>%
  kable_classic(full_width = F)

engag_freq_old <- df_engag_temp %>%
  dplyr::mutate(flag=1)%>%
  dplyr::group_by(interv_engagement_l) %>%
  # denominator is 7038 DPs in engagement analysis sample
  dplyr::summarise( count = sum(flag,na.rm=T),
             percent = 100*round((count / 7038), 3))%>%
  dplyr::ungroup() %>%
  dplyr::rename(`old engagement score` = interv_engagement_l)

engag_freq_old %>%
  kable(
    align = "c", caption = "Frequency of old engagement score $(N=7038 DPs)$")%>%
  kable_classic(full_width = F)

```
## *Preliminary* Causal Excursion Effect Estimates
  
**Research Question 3**: Investigate whether, on average, there is a proximal effect of delivering an intervention message on proximal intervention engagement.   
  
**Proximal outcome ($Y_{i,t+1}$)**: Intervention engagement (discrete: 0-3, treated as continuous)  
    
**Treatment indicator ($A_{i,t}$)**: Binary (1=Yes message, 0=No message)  

**Covariates**:  
  
-  time of day – binary (AM=0, PM=1),  
  
-  day of the week – binary (weekday=1, weekend [Fri-Sun]=0),  
  
-  prior intervention engagement – score that ranges from 0-3 averaged over past 6 decision points (i.e., approximately 72 hours), 
  
-  prior human-touch engagement – binary (1=yes, 0=no) for any email, text, or phone call made by study staff (after 72 hours, 120 hours, and 168 hours [1 week])  over past 4 decision points (i.e., approximately 48 hours).  

**Research Question 4**: Explore whether the effect of the intervention message on proximal intervention engagement differs by each of the candidate moderators listed below.  
  
**Candidate Moderators**: 
  
1. *timeofday*: time of day – binary (AM=0, PM=1),
  
2. *prior_interv_engag*: prior intervention engagement – operationalized the same as the proximal outcome, at the prior decision point,
  
- 2.2. *cov_interv_engag_72hrs*: over past 6 decision points,

3. *prop_awakeuse_prior*: prior cannabis use – operationalized the same as the proximal outcome, at the prior decision point,
  
- 3.2. *cov_prop_awakeuse_48hrs*: prior cannabis use over the past 4 decision points,
  
4. *wks_since_interv_start*: time since under treatment (i.e., since intervention start) in weeks,
  
5. *week_day_binary*: day of the week – binary (weekday=1, weekend [Fri-Sun]=0),
  
6. *prior_sent_message*: prior delivery of a message – binary (yes message=1, no message=0), at the prior decision point,
  
- 6.2. *prior_sent_messages_48hrs*: number of messages sent over past 4 decision points,

7. *interact_A_message*: interaction type A message vs. no message – binary (interaction type A message=1, no message=0),  
  
- 7.2. *interact_B_message*: interaction type B message vs. no message – binary (interaction type B message=1, no message=0),  
  
- 7.3. *interact_C_message*: interaction type C message vs. no message – binary (interaction type C message=1, no message=0),
  
8. *short_message*: short message vs. no message – binary (short message=1, no message=0),  
  
- 8.2. *long_message*: long message vs. no message - binary (long message=1, no message=0),  
  
9. *cov_humtch_binary_48hrs*: prior human-touch engagement – binary (1=yes, 0=no) for any email, text, or phone call made by study staff (after 72 hours, 120 hours, and 168 hours [1 week])  over past 4 decision points (i.e., approximately 48 hours),
   
10. *male_sex*: baseline demographic of male biological sex (0=female,1=male),  
  
11. *white_race*: baseline demographic of white race (0=not white, 1=white),   
  
12. *hispanic_ethn*: baseline demographic of hispanic or latino ethnicity (0=not hispanic or latino, 1=hispanic or latino),
  
13. *canndays_bl*: baseline cannabis use severity that is the number of days used cannabis in past month (range: 0-31), which reflects cannabis use frequency, 
  
- 13.2. *dsmsc_tot_bl*: baseline cannabis use severity that is the count of number of symptoms endorsed (range: 0-11), which reflects diagnostic severity,  
  
14. *cann_importance_bl*: baseline motivation to change that is the importance of cutting back cannabis use on a scale from 0 (Not at all) to 10 (Very) at time of baseline survey, and 
  
- 14.2. *high_cann_importance_bl* [a]: baseline motivation to change - binary (0=low motivation to change [score<5], 1=high motivation to change [score>=5]),
  
- 14.3. *cann_likely_bl* [a]: baseline likelihood to change that is how likely one is to cut back cannabis use on a scale from 0 (Not at all) to 10 (Very) at the time of baseline survey,  
  
- 14.4. *cann_conf_bl* [a]: baseline confidence to change that is how confident one is to cut back cannabis use on a scale from 0 (Not at all) to 10 (Very) at the time of baseline survey, 
  
15. *phq2_tot_bl*: baseline mental health, which is the sum across two item scale PHQ-2 ("Over the last two weeks, how often have you been bothered by any of the following problems? Little interest or pleasure in doing things" and "Over the last two weeks, how often have you been bothered by any of the following problems? Feeling down, depressed, or hopeless" with response values of 0=Not at all, 1= Several days, 2=More than half the days, and 3=Nearly every day).

Notes: All continuous candidate moderators are mean-centered. The continuous proximal engagement outcome is also mean-centered for interpretation of the fully marginal causal excursion effect. 
[a] This candidate moderator was included after the list of moderators was formalized.

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(knitr)
library(ggplot2)
library(kableExtra)
library(MRTAnalysis)
library(gt)
        
# run with same sample size as for proximal cannabis 
#print(paste0("Sample size: ",nrow(df)))

r <- list()

fit_wocov <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~1
)

r[[1]] <- summary(fit_wocov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (no covars)")
 
fit_wcov <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~ timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[2]] <- summary(fit_wcov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (with covars)")

fit1 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~timeofday,
    control_formula = ~ timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[3]] <- summary(fit1)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 1")


df_temp <- df %>% filter(!is.na(prior_interv_engag)) 
fit2 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_interv_engag_c,
    control_formula = ~timeofday + week_day_binary + prior_interv_engag_c + cov_humtch_binary_48hrs_c
)

r[[4]] <- summary(fit2)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 2")

fit2b <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_interv_engag_72hrs_c,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[5]] <- summary(fit2b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 2.2")

df_temp <- df %>% filter(!is.na(prop_awakeuse_prior)) 
fit3 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prop_awakeuse_prior_c,
    control_formula = ~prop_awakeuse_prior_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[6]] <- summary(fit3)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 3")

fit3b <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_prop_awakeuse_48hrs_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[7]] <- summary(fit3b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 3.2")

fit4 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~wks_since_interv_start,
    control_formula = ~wks_since_interv_start + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[8]] <- summary(fit4)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 4")

fit5 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~week_day_binary,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[9]] <- summary(fit5)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 5")

df_temp <- df %>% filter(!is.na(prior_sent_message)) 
fit6 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_sent_message,
    control_formula = ~prior_sent_message + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[10]] <- summary(fit7)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 6")

df_temp <- df %>% filter(!is.na(prior_sent_messages_48hrs)) 
fit6b <- wcls(
    data = df_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_sent_messages_48hrs_c,
    control_formula = ~prior_sent_messages_48hrs_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[11]] <- summary(fit6b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 6.2")


# type of interaction (A, B or C) – categorical (A=0, B=1, C=2)
df_temp <- df %>% 
  # restrict to interaction A type message and no message
  filter(!(message_type %in% c("B","C"))) %>%
  mutate(interact_A_message = ifelse(actioni==0,0,1))
fit7 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "interact_A_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[12]] <- summary(fit7)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 7")

# type of interaction (A, B or C) – categorical (A=0, B=1, C=2)
df_temp <- df %>% 
  # restrict to interaction B type message and no message
  filter(!(message_type %in% c("A","C"))) %>%
  mutate(interact_B_message = ifelse(actioni==0,0,1))
fit7b <- wcls(
    data = df_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "interact_B_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[13]] <- summary(fit7b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 7.2")


# type of interaction (A, B or C) – categorical (A=0, B=1, C=2)
df_temp <- df %>% 
  # restrict to interaction C type message and no message
  filter(!(message_type %in% c("A","B"))) %>%
  mutate(interact_C_message = ifelse(actioni==0,0,1))
fit7c <- wcls(
    data = df_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "interact_C_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[14]] <- summary(fit7c)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 7.3")

# short vs no message
df_temp <- df %>%
  # restrict to short message and no message
  filter(message_length!="Long") %>%
  mutate(short_message = ifelse(actioni==0,0,1))
fit8 <- wcls(
    data = df_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "short_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[15]] <- summary(fit8)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 8")


# # long vs no message
df_temp <- df %>%
  # restrict to long message and no message
  filter(message_length!="Short") %>%
  mutate(long_message = ifelse(actioni==0,0,1))
fit8b <- wcls(
    data = df_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "long_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[16]] <- summary(fit8b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 8.2")

fit9 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_humtch_binary_48hrs_c,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[17]] <- summary(fit9)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 9")

fit10 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~male_sex,
    control_formula = ~male_sex + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[18]] <- summary(fit10)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 10")

fit11 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~white_race,
    control_formula = ~white_race + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[19]] <- summary(fit11)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 11")

fit12 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~hispanic_ethn,
    control_formula = ~hispanic_ethn + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[20]] <- summary(fit12)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 12")

fit13 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~canndays_bl_c,
    control_formula = ~ canndays_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[21]] <- summary(fit13)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13")

fit13b <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~dsmsc_tot_bl_c,
    control_formula = ~dsmsc_tot_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[22]] <- summary(fit13b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13.2")

fit14 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_importance_bl_c,
    control_formula = ~cann_importance_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[23]] <- summary(fit14)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 14")

fit14b <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~high_cann_importance_bl,
    control_formula = ~high_cann_importance_bl + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[24]] <- summary(fit14b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 14.2")

fit14c <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_likely_bl_c,
    control_formula = ~cann_likely_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[25]] <- summary(fit14c,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 14.3")

fit14d <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_conf_bl_c,
    control_formula = ~cann_conf_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[26]] <- summary(fit14d, lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 14.4")

fit15 <- wcls(
    data = df,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~phq2_tot_bl_c,
    control_formula = ~phq2_tot_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[27]] <- summary(fit15)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 15")

res <- r %>% 
  map_df(bind_rows) %>% 
  select(model, everything()) %>%
  dplyr::mutate(model_num = gsub("Moderation Effect Model ","",model),
         model_num = ifelse(model=="Main Effect Model (no covars)","0",
                            ifelse(model=="Main Effect Model (with covars)","0.5",model_num)),
         model_num = as.numeric(model_num)
  )%>%
  dplyr::arrange(model_num) 

# create table with output
res_table <- function(res){
    res %>%
      mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>%
      rename(Term = term)%>%
      select(-c(model,model_num)) %>%
      kableExtra::kbl(booktabs = TRUE, 
                      longtable = TRUE,
                      digits=3,
                      format = "latex",
                      caption = NULL) %>%
      kableExtra::kable_styling(
        latex_options = c("striped", "hold_position", "repeat_header"),
        font_size = 10
        #full_width = TRUE
      ) %>%
      kableExtra::pack_rows(index = table(fct_inorder(res$model))) %>%
      kableExtra::column_spec(1, width = "6cm") %>%
      kableExtra::column_spec(7, width = "0.5cm") %>%
      kableExtra::column_spec(8, width = "0.5cm") %>%
      kableExtra::footnote(
        general = "prior intervention engagement, and prior human-touch engagement.",
        general_title = "", footnote_as_chunk = T
      )%>%
      kableExtra::footnote(
        general = "Notes: Model with covariates adjusts for the following: time of day, day of week,", general_title = "", footnote_as_chunk = T
      )
}

res_table(res)
```

\newpage

Next, we examine the results for proximal intervention enagement when not restricting the sample to decision points with a completed EMA.

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(knitr)
library(ggplot2)
library(kableExtra)
library(MRTAnalysis)
library(gt)

# run with sample size that reflects only missingness in proximal intervention engagement
df_engag <- full_dat %>%
  # restrict to participants with at least 3 completed EMAs
  dplyr::filter(num_emas_l >= 3) %>%
  # remove observations where the randomization information is missing
  dplyr::filter(missing_rand != 1) %>%
  dplyr::filter(!is.na(engagement_multi))

df_engag <- df_engag %>%
  dplyr::mutate(across(all_of(vars.standardize),cntr_fnc,.names = "{col}_c"),
                # mean-center the proximal outcome to aid with interpretation
                across(all_of(c("engagement_multi")),cntr_fnc,.names = "{col}_c"))

#print(paste0("Common Sample Size: ",nrow(df)))
#print(paste0("Engagement Sample Size: ",nrow(df_engag)))


r <- list()

fit_wocov_b <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~1
)


r[[1]] <- summary(fit_wocov_b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (no covars)")

fit_wcov_b <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~ timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[2]] <- summary(fit_wcov_b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (with covars)")

fit1 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~timeofday,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[3]] <- summary(fit1)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 1")

df_engag_temp <- df_engag %>% filter(!is.na(prior_interv_engag)) 
fit2 <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_interv_engag_c,
    control_formula = ~timeofday + week_day_binary + prior_interv_engag_c + cov_humtch_binary_48hrs_c
)

r[[4]] <- summary(fit2)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 2")

fit2b <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_interv_engag_72hrs_c,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[5]] <- summary(fit2b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 2.2")

df_engag_temp <- df_engag %>% filter(!is.na(prop_awakeuse_prior))
fit3 <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prop_awakeuse_prior_c,
    control_formula = ~prop_awakeuse_prior_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[6]] <- summary(fit3)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 3")

df_engag_temp <- df_engag %>% filter(!is.na(cov_prop_awakeuse_48hrs))
fit3b <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_prop_awakeuse_48hrs_c,
    control_formula = ~cov_prop_awakeuse_48hrs_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[7]] <- summary(fit3b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 3.2")

fit4 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~wks_since_interv_start,
    control_formula = ~wks_since_interv_start + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[8]] <- summary(fit4)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 4")

fit5 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~week_day_binary,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[9]] <- summary(fit5)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 5")

df_engag_temp <- df_engag %>% filter(!is.na(prior_sent_message))
fit6 <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_sent_message,
    control_formula = ~prior_sent_message + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[10]] <- summary(fit7)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 6")

df_engag_temp <- df_engag %>% filter(!is.na(prior_sent_messages_48hrs))
fit6b <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~prior_sent_messages_48hrs_c,
    control_formula = ~prior_sent_messages_48hrs_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[11]] <- summary(fit6b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 6.2")

# type of interaction (A, B or C) – categorical (A=0, B=1, C=2)
df_engag_temp <- df_engag %>%
  # restrict to interaction A type message and no message
  filter(!(message_type %in% c("B","C"))) %>%
  mutate(interact_A_message = ifelse(actioni==0,0,1))
fit7 <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "interact_A_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[12]] <- summary(fit7)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 7")

# type of interaction (A, B or C) – categorical (A=0, B=1, C=2)
df_engag_temp <- df_engag %>%
  # restrict to interaction B type message and no message
  filter(!(message_type %in% c("A","C"))) %>%
  mutate(interact_B_message = ifelse(actioni==0,0,1))
fit7b <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "interact_B_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[13]] <- summary(fit7b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 7.2")


# type of interaction (A, B or C) – categorical (A=0, B=1, C=2)
df_engag_temp <- df_engag %>%
  # restrict to interaction C type message and no message
  filter(!(message_type %in% c("A","B"))) %>%
  mutate(interact_C_message = ifelse(actioni==0,0,1))
fit7c <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "interact_C_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[14]] <- summary(fit7c)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 7.3")

# short vs no message
df_engag_temp <- df_engag %>%
  # restrict to short message and no message
  filter(message_length!="Long") %>%
  mutate(short_message = ifelse(actioni==0,0,1))
fit8 <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "short_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[15]] <- summary(fit8)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 8")


# # long vs no message
df_engag_temp <- df_engag %>%
  # restrict to long message and no message
  filter(message_length!="Short") %>%
  mutate(long_message = ifelse(actioni==0,0,1))
fit8b <- wcls(
    data = df_engag_temp,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "long_message",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[16]] <- summary(fit8b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 8.2")

fit9 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cov_humtch_binary_48hrs_c,
    control_formula = ~timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[17]] <- summary(fit9)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 9")

fit10 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~male_sex,
    control_formula = ~male_sex + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[18]] <- summary(fit10)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 10")

fit11 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~white_race,
    control_formula = ~white_race + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[19]] <- summary(fit11)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 11")

fit12 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~hispanic_ethn,
    control_formula = ~hispanic_ethn + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[20]] <- summary(fit12)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 12")

fit13 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~canndays_bl_c,
    control_formula = ~ canndays_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[21]] <- summary(fit13)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13")

fit13b <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~dsmsc_tot_bl_c,
    control_formula = ~dsmsc_tot_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[22]] <- summary(fit13b,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 13.2")

fit14 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_importance_bl_c,
    control_formula = ~cann_importance_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[23]] <- summary(fit14)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 14")

fit14b <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~high_cann_importance_bl,
    control_formula = ~high_cann_importance_bl + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[24]] <- summary(fit14b)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 14.2")

fit14c <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_likely_bl_c,
    control_formula = ~cann_likely_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[25]] <- summary(fit14c,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 14.3")

fit14d <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_conf_bl_c,
    control_formula = ~cann_conf_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[26]] <- summary(fit14d,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 14.4")

fit15 <- wcls(
    data = df_engag,
    id = "id",
    outcome = "engagement_multi_c",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~phq2_tot_bl_c,
    control_formula = ~phq2_tot_bl_c + timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[27]] <- summary(fit15,lincomb = c(1, 1))$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Moderation Effect Model 15")

res <- r %>% 
  map_df(bind_rows) %>% 
  select(model, everything()) %>%
  dplyr::mutate(model_num = gsub("Moderation Effect Model ","",model),
         model_num = ifelse(model=="Main Effect Model (no covars)","0",
                            ifelse(model=="Main Effect Model (with covars)","0.5",model_num)),
         model_num = as.numeric(model_num)
  )%>%
  dplyr::arrange(model_num) 

# create table with output
res_table <- function(res){
    res %>%
      mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>%
      rename(Term = term)%>%
      select(-c(model,model_num)) %>%
      kableExtra::kbl(booktabs = TRUE, 
                      longtable = TRUE,
                      digits=3,
                      format = "latex",
                      caption = NULL) %>%
      kableExtra::kable_styling(
        latex_options = c("striped", "hold_position", "repeat_header"),
        font_size = 10
        #full_width = TRUE
      ) %>%
      kableExtra::pack_rows(index = table(fct_inorder(res$model))) %>%
      kableExtra::column_spec(1, width = "6cm") %>%
      kableExtra::column_spec(7, width = "0.5cm") %>%
      kableExtra::column_spec(8, width = "0.5cm") %>%
      kableExtra::footnote(
        general = "prior intervention engagement, and prior human-touch engagement.",
        general_title = "", footnote_as_chunk = T
      )%>%
      kableExtra::footnote(
        general = "Notes: Model with covariates adjusts for the following: time of day, day of week,", general_title = "", footnote_as_chunk = T
      )
}

res_table(res)
```
\newpage

Additionally, let us examine the causal excursion effect of prompting with a message (vs. no message) for the binary version of proximal engagement (1=Yes engaged with the app, 0=No app engagement). Note that the binary proximal engagement outcome uses the variable *engagement_binary*, which is already adjusted to reflect the next decision point. 

First, we will perform this analysis for the analytic sample which removes decision points without a completed EMA.

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(knitr)
library(ggplot2)
library(kableExtra)
library(MRTAnalysis)
library(gt)

r <- list()

fit_wocov <- emee(
    data = df,
    id = "id",
    outcome = "engagement_binary",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~1
)

r[[1]] <- summary(fit_wocov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (no covars)")

fit_wcov <- emee(
    data = df,
    id = "id",
    outcome = "engagement_binary",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~ timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[2]] <- summary(fit_wcov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (with covars)")

res <- r %>% 
  map_df(bind_rows) %>% 
  select(model, everything()) %>%
  dplyr::mutate(model_num = gsub("Moderation Effect Model ","",model),
         model_num = ifelse(model=="Main Effect Model (no covars)","0",
                            ifelse(model=="Main Effect Model (with covars)","0.5",model_num)),
         model_num = as.numeric(model_num)
  )%>%
  dplyr::arrange(model_num) 

# create table with output
res_table <- function(res){
    res %>%
      mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>%
      rename(Term = term,
             `Log Odds Estimate` = Estimate)%>%
      select(-c(model,model_num)) %>%
      kableExtra::kbl(booktabs = TRUE, 
                      longtable = TRUE,
                      digits=3,
                      format = "latex",
                      caption = NULL) %>%
      kableExtra::kable_styling(
        latex_options = c("striped", "hold_position", "repeat_header"),
        font_size = 10
        #full_width = TRUE
      ) %>%
      kableExtra::pack_rows(index = table(fct_inorder(res$model))) %>%
      kableExtra::column_spec(1, width = "6cm") %>%
      kableExtra::column_spec(7, width = "0.5cm") %>%
      kableExtra::column_spec(8, width = "0.5cm") %>%
      kableExtra::footnote(
        general = "prior intervention engagement, and prior human-touch engagement.",
        general_title = "", footnote_as_chunk = T
      )%>%
      kableExtra::footnote(
        general = "Notes: Model with covariates adjusts for the following: time of day, day of week,", general_title = "", footnote_as_chunk = T
      )
}

res_table(res)

```

Second, we will perform this analysis for the analytic sample which does *not* additionally remove decision points without a completed EMA.


```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(knitr)
library(ggplot2)
library(kableExtra)
library(MRTAnalysis)
library(gt)

r <- list()

fit_wocov <- emee(
    data = df_engag,
    id = "id",
    outcome = "engagement_binary",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~1
)

r[[1]] <- summary(fit_wocov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (no covars)")

fit_wcov <- emee(
    data = df_engag,
    id = "id",
    outcome = "engagement_binary",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~1,
    control_formula = ~ timeofday + week_day_binary + cov_interv_engag_72hrs_c + cov_humtch_binary_48hrs_c
)

r[[2]] <- summary(fit_wcov)$causal_excursion_effect %>% as_tibble(rownames = "term") %>%
  mutate(model="Main Effect Model (with covars)")

res <- r %>% 
  map_df(bind_rows) %>% 
  select(model, everything()) %>%
  dplyr::mutate(model_num = gsub("Moderation Effect Model ","",model),
         model_num = ifelse(model=="Main Effect Model (no covars)","0",
                            ifelse(model=="Main Effect Model (with covars)","0.5",model_num)),
         model_num = as.numeric(model_num)
  )%>%
  dplyr::arrange(model_num) 

# create table with output
res_table <- function(res){
    res %>%
      mutate(term = str_replace(term, "\\(Intercept\\)", "Intercept")) %>%
      rename(Term = term,
             `Log Odds Estimate` = Estimate)%>%
      select(-c(model,model_num)) %>%
      kableExtra::kbl(booktabs = TRUE, 
                      longtable = TRUE,
                      digits=3,
                      format = "latex",
                      caption = NULL) %>%
      kableExtra::kable_styling(
        latex_options = c("striped", "hold_position", "repeat_header"),
        font_size = 10
        #full_width = TRUE
      ) %>%
      kableExtra::pack_rows(index = table(fct_inorder(res$model))) %>%
      kableExtra::column_spec(1, width = "6cm") %>%
      kableExtra::column_spec(7, width = "0.5cm") %>%
      kableExtra::column_spec(8, width = "0.5cm") %>%
      kableExtra::footnote(
        general = "prior intervention engagement, and prior human-touch engagement.",
        general_title = "", footnote_as_chunk = T
      )%>%
      kableExtra::footnote(
        general = "Notes: Model with covariates adjusts for the following: time of day, day of week,", general_title = "", footnote_as_chunk = T
      )
}

res_table(res)
```
\newpage
# 3. Draft Interpretation Sentences 

## Motivation Score Effect Moderation for Proximal Cannabis Use

The effect moderation model is specified as follows:
  
$Y_{i,t+1}|Z = \beta_0 + \beta_1I(A_{it}-0.5) + \beta_2Mc_i + \beta_3 (I(A_{it}-0.5)*Mc_i) + \epsilon$   
  
where $Z$ reflects the matrix of precision covariates and the action probabilities, denoted by $A_{it}$, are centered. We also grand mean center the candidate moderator of motivation score, denoted by $Mc_i$. 

$E(Y_{i,t+1}|Z, A_{it}=0) = \beta_0 + \beta_2Mc_i + \epsilon$  
$E(Y_{i,t+1}|Z, A_{it}=1) = \beta_0 + \beta_1 + \beta_2Mc_i + \beta_3Mc_i + \epsilon$  
$E(Y_{i,t+1}|Z, A_{it}=1) = (\beta_0 + \beta_1) + (\beta_2 + \beta_3)Mc_i + \epsilon$ 

Next, let us examine the estimates and plug in the corresponding values to the simple slopes representation of the interaction effect.
```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}  
print(fit13_can)
```

$P(Y_{i,t+1}|Z, A_{it}=0) = \hat{\beta_0} + \hat{\beta_2}Mc_i$     
$P(Y_{i,t+1}|Z, A_{it}=0) = 0.1794963082 +  -0.0004387147Mc_i$        
$P(Y_{i,t+1}|Z, A_{it}=1) = (\hat{\beta_0} + \hat{\beta_1}) + (\hat{\beta_2} + \hat{\beta_3})Mc_i$   
$P(Y_{i,t+1}|Z, A_{it}=1)  = (0.1794963082 + 0.0086471773) + (-0.0004387147 + (-0.0052578510))Mc_i$  
$P(Y_{i,t+1}|Z, A_{it}=1)  = (0.1881435) + (-0.005696566)Mc_i$

\newpage
Next, since motivation score is continuous to better understand the effect moderation, we plug in -1 SD, mean and +1 SD from the mean of motivation to change and compute the difference in slopes, that is, $\beta_2 + \beta_3Mc$. The results are shown in plot below with three grey vertical lines at +/- 1 SD and the mean.

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}  

#quantile(df$cann_importance_bl, prob=c(.25,.5,.75), type=1)
#sd(df$cann_importance_bl_c)
#round(mean(df$cann_importance_bl_c),4)
#summary(fit13_can, lincomb = rbind(c(1, -2.28), c(1, 0.001), c(1, 2.28)))

colors <- c("#dc0000ff","#00a087ff")
means1 <- df %>%
  group_by(id) %>%
  summarise(mean_canuse = mean(prop_awakeuse,na.rm=T))%>%
  ungroup()

m1 <- df %>% 
  left_join(means1, by="id") %>% 
  mutate(Action = factor(actioni,levels=c(0,1),labels=c("No Message","Yes Message"))
         #,canuse = prop_awakeuse - mean_canuse
         ) %>% 
  filter(!is.na(Action)) %>%
  mutate(flag= 1) %>%
  group_by(cann_importance_bl_c, Action) %>% 
  summarise(mcanuse=mean(prop_awakeuse, na.rm = TRUE),
            count = sum(flag,na.rm=T)) %>%
  ggplot(aes(cann_importance_bl_c, mcanuse, color = Action, fill=Action, size=count)) +
  geom_vline(xintercept = -2.28, color="gray70", linetype="twodash") + 
  geom_vline(xintercept = 2.28, color="gray70", linetype="twodash") + 
  geom_vline(xintercept = 0, color="gray70", linetype="twodash") + 
  geom_text(aes(x=-1.2, 
                label="Diff at -1 SD: 0.020", y=0.15), 
            colour="black", size=8/.pt) +
  geom_text(aes(x=1, 
                label="Diff at mean: 0.008", y=0.15), 
            colour="black", size=8/.pt) +
  geom_text(aes(x=3.4, 
                label="Diff at +1 SD: -0.003", y=0.15), 
            colour="black", size=8/.pt) +
  geom_abline(intercept = 0.1794963082, slope=-0.0004387147, linewidth=1, color=colors[1], linetype="dashed") +
  geom_abline(intercept = 0.1881435, slope=-0.005696566, linewidth=1, color=colors[2], linetype="dashed") +
  geom_hline(yintercept = 0, color="gray",) + 
  geom_point(alpha=0.5) +
  scale_size(range = c(1.5,6), name="Count of Decision Points") + 
  scale_color_manual(values = colors) +
  scale_fill_manual(values = colors) +
  #coord_cartesian(ylim=c(0,0.6)) +
  #stat_smooth(method = lm, linewidth=1, se=FALSE, fullrange = TRUE) +
  #scale_x_continuous(expand=c(0,0.1),limits=c(-5,5.2)) +
  theme_bw()+
  theme(legend.position = "bottom",
        legend.title=element_text(size=9),
        plot.title=element_text(size=10), 
        axis.title=element_text(size=10),
        axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10)) +
  labs(x = "Standardized Baseline Motivation Score",
       y = "Estimated Proportion of Waking Hours Using Cannabis") 

print(m1)


# obtain fit for uncentered motivation score
fit13_can_unc <- wcls(
    data = df,
    id = "id",
    outcome = "prop_awakeuse",
    treatment = "actioni",
    rand_prob = "probi",
    moderator_formula = ~cann_importance_bl,
    control_formula = ~cov_prop_awakeuse_48hrs_c + cov_interv_engag_24hrs_c + timeofday + week_day_binary + cann_importance_bl + cannhours_bl_c + cannwake_bl_c
)

# note we obtain the updated intercept values for the simple slopes
#print(fit13_can_unc)
#quantile(df$cann_importance_bl, prob=c(.25,.5,.75), type=1)
#sd(df$cann_importance_bl)
#round(mean(df$cann_importance_bl),4)
#summary(fit13_can_unc, lincomb = rbind(c(1, 2.565786), c(1, 4.8461), c(1, 7.126414)))

m2 <- df %>% 
  left_join(means1, by="id") %>% 
  mutate(Action = factor(actioni,levels=c(0,1),labels=c("No Message","Yes Message"))
         #,canuse = prop_awakeuse - mean_canuse
         ) %>% 
  filter(!is.na(Action)) %>%
  mutate(flag= 1) %>%
  group_by(cann_importance_bl, Action) %>% 
  summarise(mcanuse=mean(prop_awakeuse, na.rm = TRUE),
            count = sum(flag,na.rm=T)) %>%
  ggplot(aes(cann_importance_bl, mcanuse, color = Action, fill=Action, size=count)) +
  geom_vline(xintercept = 2.565786, color="gray70", linetype="twodash") + 
  geom_vline(xintercept = 7.126414, color="gray70", linetype="twodash") + 
  geom_vline(xintercept = 4.8461, color="gray70", linetype="twodash") + 
  geom_text(aes(x=2.565786+0.95, 
                label=stringr::str_wrap("\nDiff at -1 SD: 0.020 (95% CI: 0.006, 0.034; p=0.002)",25),
                y=0.12), 
            colour="black", size=7/.pt) +
  geom_text(aes(x=4.8461+1, 
                label=stringr::str_wrap("\nDiff at mean: 0.008 (95% CI: -0.001, 0.018; p=0.113)",25),
                y=0.12), 
            colour="black", size=7/.pt) +
  geom_text(aes(x=7.126414+1, 
                label=stringr::str_wrap("\nDiff at +1 SD: -0.003 (95% CI: -0.017, 0.010; p=0.834)",25),
                y=0.12), 
            colour="black", size=7/.pt) +
  geom_abline(intercept = 0.1835100493, slope=-0.0004387147, linewidth=1, color=colors[1], linetype="dashed") +
  geom_abline(intercept = 0.2176373, slope=-0.005696566, linewidth=1, color=colors[2], linetype="dashed") +
  geom_hline(yintercept = 0, color="gray",) + 
  geom_point(alpha=0.5) +
  scale_size(range = c(1.5,6), name="Count of Decision Points") + 
  scale_color_manual(values = colors) +
  scale_fill_manual(values = colors) +
  #coord_cartesian(ylim=c(0,0.6)) +
  #stat_smooth(method = lm, linewidth=1, se=FALSE, fullrange = TRUE) +
  #scale_x_continuous(expand=c(0,0.1),limits=c(-5,5.2)) +
  theme_bw()+
  theme(legend.position = "bottom",
        legend.title=element_text(size=9),
        plot.title=element_text(size=10), 
        axis.title=element_text(size=10),
        axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10)) +
  labs(x = "Baseline Motivation Score (0='Not at all' to 10='Very')",
       y = "Estimated Proportion of Waking Hours Using Cannabis") 

print(m2)
```

\newpage
# 4. Additional Exploratory Analyses

Below are the additional exploratory research qustions (ERQ).

- ERQ 1A. Examine whether there is a correlation between the cumulative number of prompts and proximal cannabis use, over time. Refer to *cumul_num_message* in Table 17.
  
- ERQ 1B. And examine whether there is a correlation between the total number of prompts a person received and cannabis use days at the end of the study and at 2-month follow up. Refer to *tot_num_message* in Table 18.
  
- ERQ 2A. Examine whether there is a correlation between prior engagement and proximal cannabis use, over time. Refer to *prior_interv_engag*,*cov_interv_engag_72hrs*, *cov_interv_engag_48hrs*, *cov_interv_engag_24hrs* in Table 17.
  
- ERQ 2B. And examine whether a correlation exists between average engagement and cannabis use days at the end of the study and at 2-month follow up. Refer to *avg_engagement_multi* in Table 18.
  
- ERQ 3. Examine whether there is a correlation between the mean proportion of cannabis use during waking hours (over study days) and cannabis use days reported at post-test and 2-month follow up. Refer to *avg_prop_awakeuse* in Table 18.
  
- ERQ 4A. Examine whether there is a correlation between the prior self-reported behavior activity and proximal cannabis use, over time. Refer to *prior_beh_activity_response* in Table 17.

- ERQ 4B. And examine whether there is a correlation between the mean self-reported behavior activity and cannabis use days at the end of the study and at 2-month follow up. Refer to *avg_beh_activity_response* in Table 18.

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}  

## First perform analyses ERQ 1A, ERQ 2A, and ERQ 4A that are over time at the decision point level
require(geepack)
# initialize output
reg_output <- data.frame()
rhs.vars.linear.me <- c("cumul_num_message","prior_interv_engag","cov_interv_engag_72hrs", "cov_interv_engag_48hrs", "cov_interv_engag_24hrs", "prior_beh_activity_response")

# perform GEE regressions
for(var_name in rhs.vars.linear.me) {
  gee_formula <- as.formula(paste0("prop_awakeuse ~ ",var_name," + timeofday + prop_awakeuse_prior"))
  data <- df %>%
    select(all_of(all.vars(gee_formula)), id) %>%
    na.omit()
  
  gee_fit <- geeglm(gee_formula, 
                    data = data, 
                    id = id, 
                    family = gaussian(), 
                    corstr = "independence",
                    std.err = "san.se") # the default
  sum_res <- summary(gee_fit)
  
  reg_temp <- as.data.frame(sum_res$coefficients)
  reg_temp$Covariate <- rownames(reg_temp)
  rownames(reg_temp) <- c()
  reg_temp$RHS_variable <- var_name

  reg_output <- rbind(reg_output,reg_temp)
}

reg_results <- reg_output %>%
  rename(SE=`Std.err`, Term=Covariate, pvalue=`Pr(>|W|)`) %>%
  dplyr::mutate(UI_lower = Estimate - (1.96 * SE),
                UI_upper = Estimate + (1.96 * SE),
                across(where(is.numeric), round, 3)
                )%>%
  relocate(RHS_variable, Term, .before=Estimate)%>%
  filter(RHS_variable == Term) %>%
  select(Term,Estimate,SE,UI_lower,UI_upper,pvalue)

reg_results %>%
    kable(
    align = "c", caption = "Univariate associations of variable with proximal proportion of waking hours using cannabis, adjusting for time of day and prior cannabis use and using generalized estimating equations")%>%
  kable_classic(full_width = F)

## Second perform analyses that use aggregates across the study time period
agg_df <- df %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(
                tot_num_message = sum(actioni,na.rm=T),
                avg_engagement_multi = mean(engagement_multi,na.rm=T),
                avg_prop_awakeuse = mean(prop_awakeuse,na.rm=T),
                avg_beh_activity_response = mean(prior_beh_activity_response,na.rm=T)
                # avg_prop_awakeuse_weighted = mean(prop_awakeuse,na.rm=T)
                ) %>%
  dplyr::ungroup() %>%
  dplyr::select(id, completed_posttest, completed_fu2mo, canndays_pt, canndays_fu, tot_num_message, avg_engagement_multi, avg_prop_awakeuse, avg_beh_activity_response) %>%
  dplyr::distinct(id, completed_posttest, completed_fu2mo, canndays_pt, canndays_fu, tot_num_message, avg_engagement_multi, avg_prop_awakeuse, avg_beh_activity_response) %>%
  # code true zeros
  dplyr::mutate(canndays_pt = ifelse(completed_posttest==1 & is.na(canndays_pt),0,canndays_pt),
                canndays_fu = ifelse(completed_fu2mo==1 & is.na(canndays_fu),0,canndays_fu))
```
\newpage
```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE} 
## Second perform analyses that use aggregates across the study time period
agg_df <- df %>%
  dplyr::group_by(id) %>%
  dplyr::mutate(
                tot_num_message = sum(actioni,na.rm=T),
                avg_engagement_multi = mean(engagement_multi,na.rm=T),
                avg_prop_awakeuse = mean(prop_awakeuse,na.rm=T),
                avg_beh_activity_response = mean(prior_beh_activity_response,na.rm=T),
                # avg_prop_awakeuse_weighted = mean(prop_awakeuse,na.rm=T)
                tot_num_message_sq = tot_num_message^2
                ) %>%
  dplyr::ungroup() %>%
  dplyr::select(id, completed_posttest, completed_fu2mo, canndays_pt, canndays_fu, tot_num_message, tot_num_message_sq, avg_engagement_multi, avg_prop_awakeuse, avg_beh_activity_response, cann_importance_bl, canndays_bl) %>%
  dplyr::distinct(id, completed_posttest, completed_fu2mo, canndays_pt, canndays_fu, tot_num_message, tot_num_message_sq, avg_engagement_multi, avg_prop_awakeuse, avg_beh_activity_response, cann_importance_bl, canndays_bl) %>%
  # code true zeros
  dplyr::mutate(canndays_pt = ifelse(completed_posttest==1 & is.na(canndays_pt),0,canndays_pt),
                canndays_fu = ifelse(completed_fu2mo==1 & is.na(canndays_fu),0,canndays_fu))

# initialize output
cs_reg_output <- data.frame()
rhs.vars.linear <- c("tot_num_message", "avg_engagement_multi", "avg_prop_awakeuse", "avg_beh_activity_response")

# perform cross-sectional regressions
for(var_name in rhs.vars.linear) {
  
  lm_formula <- paste0("canndays_pt ~ ",var_name, "+ canndays_bl") 
  res_lm.v1 <- lm(formula = lm_formula, data = agg_df)
  sum_res.v1 <- summary(res_lm.v1)
  
  reg_temp.v1 <- as.data.frame(sum_res.v1$coefficients) %>%
    mutate(Outcome = "Post Test Cann. Use Days",
          RHS_variable = var_name,
          Order = 1)
  reg_temp.v1$Covariate <- rownames(reg_temp.v1)
  rownames(reg_temp.v1) <- c()
  
  lm_formula <- paste0("canndays_fu ~ ",var_name, "+ canndays_bl") 
  res_lm.v2 <- lm(formula = lm_formula, data = agg_df)
  sum_res.v2 <- summary(res_lm.v2)
  
  reg_temp.v2 <- as.data.frame(sum_res.v2$coefficients) %>%
    mutate(Outcome = "2-Month Follow up Cann. Use Days",
          RHS_variable = var_name,
          Order = 2)
  reg_temp.v2$Covariate <- rownames(reg_temp.v2)
  rownames(reg_temp.v2) <- c()
  
  lm_formula <- paste0("avg_prop_awakeuse ~ ",var_name, "+ canndays_bl") 
  res_lm.v3 <- lm(formula = lm_formula, data = agg_df)
  sum_res.v3 <- summary(res_lm.v3)
  
  reg_temp.v3 <- as.data.frame(sum_res.v3$coefficients) %>%
  mutate(Outcome = "Avg. Prop. Awake Hrs Using Cannabis",
        RHS_variable = var_name,
        Order = 3)
  reg_temp.v3$Covariate <- rownames(reg_temp.v3)
  rownames(reg_temp.v3) <- c()  

  
  cs_reg_output <- bind_rows(cs_reg_output, reg_temp.v1, reg_temp.v2, reg_temp.v3) 
}

cs_reg_results <- cs_reg_output %>%
  rename(SE=`Std. Error`, Term=Covariate, pvalue=`Pr(>|t|)`) %>%
  dplyr::mutate(UI_lower = Estimate - (1.96 * SE),
                UI_upper = Estimate + (1.96 * SE),
                across(where(is.numeric), round, 3)
                )%>%
  relocate(Outcome, RHS_variable, Term, .before=Estimate)%>%
  filter(RHS_variable == Term) %>%
  arrange(Order) %>%
  filter(!((Order==3) & (Term=="avg_prop_awakeuse"))) %>%
  select(Outcome,Term,Estimate,SE,UI_lower,UI_upper,pvalue)


cs_reg_results %>%
    kable(
    align = "c", caption = "Univariate associations of variable with cannabis use days at post-test and at 2-month follow up and with avg. prop. of waking hours using cannabis, when adjusting for baseline cannabis use days, using cross-sectional linear regressions")%>%
  kable_classic(full_width = F)

# examine quadratic form of cumulative number of messages over time
q_reg_output <- data.frame()

gee_formula <- as.formula(paste0("prop_awakeuse ~ cumul_num_message + cumul_num_message_sq + timeofday + prop_awakeuse_prior"))
data <- df %>%
  select(all_of(all.vars(gee_formula)), id) %>%
  na.omit()

gee_fit <- geeglm(gee_formula, 
                  data = data, 
                  id = id, 
                  family = gaussian(), 
                  corstr = "independence",
                  std.err = "san.se") # the default
sum_res <- summary(gee_fit)
  
q_reg_output <- as.data.frame(sum_res$coefficients) %>%
  mutate(Outcome = "Proximal Prop. Awake Hrs Using Cannabis")
q_reg_output$Covariate <- rownames(q_reg_output)
rownames(q_reg_output) <- c()

q_reg_results <- q_reg_output %>%
  rename(SE=`Std.err`, Term=Covariate, pvalue=`Pr(>|W|)`) %>%
  dplyr::mutate(UI_lower = Estimate - (1.96 * SE),
                UI_upper = Estimate + (1.96 * SE),
                across(where(is.numeric), round, 3)
                )%>%
  relocate(Outcome, Term, .before=Estimate)%>%
  select(Outcome,Term,Estimate,SE,UI_lower,UI_upper,pvalue)

q_reg_results %>%
    kable(
    align = "c", caption = "Examining quadratic trend in cumulative number of messages in terms of  proximal proportion of waking hours using cannabis, when adjusting for time of day and prior cannabis use, using generalized estimating equations")%>%
  kable_classic(full_width = F)
```
\newpage
```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE} 
# examine interaction with baseline motivation to change
cs_reg_output <- data.frame()
rhs.vars.linear <- c("tot_num_message", "avg_engagement_multi", "avg_prop_awakeuse", "avg_beh_activity_response")

# perform cross-sectional regressions
for(var_name in rhs.vars.linear) {
  
  lm_formula <- paste0("canndays_pt ~ ",var_name,"*cann_importance_bl", "+ canndays_bl") 
  res_lm.v1 <- lm(formula = lm_formula, data = agg_df)
  sum_res.v1 <- summary(res_lm.v1)
  
  reg_temp.v1 <- as.data.frame(sum_res.v1$coefficients) %>%
    mutate(Outcome = "V1",
          RHS_variable = var_name,
          Order = 1)
  reg_temp.v1$Covariate <- rownames(reg_temp.v1)
  rownames(reg_temp.v1) <- c()
  
  lm_formula <- paste0("canndays_fu ~ ",var_name,"*cann_importance_bl", "+ canndays_bl") 
  res_lm.v2 <- lm(formula = lm_formula, data = agg_df)
  sum_res.v2 <- summary(res_lm.v2)
  
  reg_temp.v2 <- as.data.frame(sum_res.v2$coefficients) %>%
    mutate(Outcome = "V2",
          RHS_variable = var_name,
          Order = 2)
  reg_temp.v2$Covariate <- rownames(reg_temp.v2)
  rownames(reg_temp.v2) <- c()
  
  lm_formula <- paste0("avg_prop_awakeuse ~ ",var_name,"*cann_importance_bl", "+ canndays_bl") 
  res_lm.v3 <- lm(formula = lm_formula, data = agg_df)
  sum_res.v3 <- summary(res_lm.v3)
  
  reg_temp.v3 <- as.data.frame(sum_res.v3$coefficients) %>%
  mutate(Outcome = "V3",
        RHS_variable = var_name,
        Order = 3)
  reg_temp.v3$Covariate <- rownames(reg_temp.v3)
  rownames(reg_temp.v3) <- c()  

  
  cs_reg_output <- bind_rows(cs_reg_output, reg_temp.v1, reg_temp.v2, reg_temp.v3) 
}

cs_reg_results <- cs_reg_output %>%
  rename(SE=`Std. Error`, Term=Covariate, pvalue=`Pr(>|t|)`) %>%
  dplyr::mutate(UI_lower = Estimate - (1.96 * SE),
                UI_upper = Estimate + (1.96 * SE),
                across(where(is.numeric), round, 3)
                )%>%
  relocate(Outcome, RHS_variable, Term, .before=Estimate)%>%
  #filter(RHS_variable == Term) %>%
  arrange(Order) %>%
  filter(!((Order==3) & (Term=="avg_prop_awakeuse"))& Term!="(Intercept)" & Term!="canndays_bl") %>%
  select(Outcome,Term,Estimate,SE,UI_lower,UI_upper,pvalue)


cs_reg_results %>%
    kable(
    align = "c", caption = "Baseline motivation to change interaction with each variable, for cannabis use days at post-test (V1), at 2-month follow up (V2) and with avg. prop. of waking hours using cannabis (V3), when adjusting for baseline cannabis use days, using cross-sectional linear regressions")%>%
  kable_classic(full_width = F)


```

\newpage
# 5. Examining Types of Messages, Using Categorical Treatment

First, let us examine the bearing of message interaction type A (acknowledge) / B (acknowledge + click additional resources link) / C (acknowledge + fill in the blank/select an option) on proximal proportion of waking hours using cannabis, as well as the same for message length short (150 characters or less) / long (200 characters or more).

```{r, tidy.opts=list(width.cutoff=60), tidy=TRUE, echo=FALSE}  

source("wcls_categorical_treatment.R")

## examine bearing of message interaction type A, B, C on proximal cannabis use, as well as the same for message length long, short
# create additional categorical treatement variable and adjust probabilities
df_categ <- df %>%
  # remove additional 9 observations where the message interaction type 
  # and message length are missing from the dashboard
  dplyr::filter(!(is.na(message_id) & actioni==1))%>% # 5,271->5,266 decision points remaining
  dplyr::mutate(A_inter_type = ifelse(actioni==0,0,as.numeric(message_interaction_type)),
         prob_A_inter_type = ifelse(actioni==0, probi, probi * (1/3)),
         A_length_type = ifelse(actioni==0,0,
                                ifelse(message_length == "Short",1,
                                       ifelse(message_length == "Long", 2, 999))),
         prob_A_length_type = ifelse(actioni==0, probi, probi * (1/2)),
         # create additional variables
         Y = prop_awakeuse,
         S = as.numeric(A_length_type),
         prob_A = prob_A_length_type,
         A = as.numeric(A_length_type),
         userid = id,
         time = decision_point,
         I = 1) %>%
  dplyr::select(userid, time, Y, A, I, S, prob_A)

# fit  <- wcls_categorical_treatment(
#     dta = df_categ,
#     id_varname = "id",
#     treatment_varname = "A_inter_type",
#     outcome_varname = "prop_awakeuse_c",
#     #control_varname = c("S", "time"),
#     control_varname = c("cov_prop_awakeuse_48hrs_c", "cov_interv_engag_24hrs_c", "timeofday", "week_day_binary", "cann_importance_bl_c", "cannhours_bl_c", "cannwake_bl_c"),
#     moderator_varname = c(),
#     rand_prob_varname = "prob_A_inter_type",
#     estimator_initial_value = NULL,
#     trt_level = 3 # number of active treatment levels (excluding 0, the reference level)
#     #,avail_varname = "I"
# )
# 
# fit$beta_hat # effect estimate
# fit$beta_se_adjusted # standard error (incorporated small-sample correction)
# fit$beta_conf_int_adjusted_t # 95% confidence interval (incorporated small-sample correction)
# 
# 
# # examine bearing of message length short, long on proximal cannabis use 
# fit  <- wcls_categorical_treatment(
#     dta = df_categ,
#     id_varname = "userid",
#     treatment_varname = "A",
#     outcome_varname = "Y",
#     control_varname = c(),
#     #control_varname = c("S", "time"),
#     #control_varname = c("cov_prop_awakeuse_48hrs_c", "cov_interv_engag_24hrs_c", "timeofday", "week_day_binary", "cann_importance_bl_c", "cannhours_bl_c", "cannwake_bl_c"),
#     moderator_varname = c(),
#     rand_prob_varname = "prob_A",
#     estimator_initial_value = NULL,
#     trt_level = 2 # number of active treatment levels (excluding 0, the reference level)
#     #,avail_varname = "I"
# )
# 
# fit$beta_hat # effect estimate
# fit$beta_se_adjusted # standard error (incorporated small-sample correction)
# fit$beta_conf_int_adjusted_t # 95% confidence interval (incorporated small-sample correction)

```
  